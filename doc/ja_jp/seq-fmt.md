- Table of Content
{:toc}

# シーケンスデータ仕様

## データレイアウト

シーケンスデータは、複数の曲データを内包する形とする。

音色定義およびエンベロープ定義は同ブロック内で使いまわしができるものとする。


|                                  | データ長 | 概要                                              |
|:--------------------------------:|----------|---------------------------------------------------|
| ブロックヘッダ                   | 1 (**a**)| 曲データヘッダアドレス数                          |
| ^                                | **a**x2  | 曲データヘッダアドレス x **a**                    |
| ^                                | 1 (**b**)| 通常音色定義テーブル長                            |
| ^                                | **b**    | 通常音色定義テーブル                              |
| ^                                | 1 (**c**)| 打楽器音色定義テーブル長                          |
| ^                                | **c**    | 打楽器音色定義テーブル                            |
| ^                                | 1 (**d**)| エンベロープ定義数                                |
| ^                                | **d**x2  | エンベロープデータへのアドレス                    |
| エンベロープ                     | 任意     | エンベロープデータ                                |
| 曲データ (1) ヘッダ              | 1 (**e**)| トラック数                                        |
| ^                                | **e**x2  | 曲データ (1) のトラックデータへのアドレス x **d** |
| 曲データ (1) tick数テーブル      | 10       | 曲データ (1) で使うtick数テーブル                 |
| 曲データ バイトコード            | 任意     | 曲データ (1) のトラックデータ                     |
| 曲データ (2) ヘッダ              | 1 (**f**)| トラック数                                        |
| ^                                | **f**x2  | 曲データ (2) のトラックデータへのアドレス x **e** |
| 曲データ (2) tick数テーブル      | 10       | 曲データ (2) で使うtick数テーブル                 |
| 曲データ バイトコード            | 任意     | 曲データ (2) のトラックデータ                     |
| :                                | :        | :                                                 |
| - - -                            | ?        | サブルーチンデータ                                |

上記表で、ブロックヘッダ ( **曲データアドレス数** 〜 **エンベロープデータへのアドレス** ) を除く  
ブロックは順番が前後しても支障はない。

トラック数は最大12トラックまでの可変数で、多ければ多いほど処理は重く、また音飛び率も上がる。  
10トラック内に収めるのが、処理的にも同時発音数的にも無難である。

音色定義テーブルについては、通常・打楽器いずれも最大長が255バイトまでである。  
1音色で5バイト長とすると、1つのブロック内で最大51個まで定義できる。



## バイトコード

### 音符

下位 4bits で 音符 / 休符 / タイ を表現し、上位 4bits でtick数が決まる。

ただし、 `0xB0` 以上はコマンドとする。

tick数は、シーケンスヘッダ内で定義されるtickテーブルのインデックス番号を指定する。  
このテーブルは、シーケンスデータ内で利用頻度の高いtick数がコンパイラによって自動的に構築される。

#### 音階

| 値   | mml  | 概要                               |
|------|------|------------------------------------|
| 0x?0 | c    | ド                                 |
| 0x?1 | c+   | ド #                               |
| 0x?2 | d    | レ                                 |
| 0x?3 | d+   | レ #                               |
| 0x?4 | e    | ミ                                 |
| 0x?5 | f    | ファ                               |
| 0x?6 | f+   | ファ #                             |
| 0x?7 | g    | ソ                                 |
| 0x?8 | g+   | ソ #                               |
| 0x?9 | a    | ラ                                 |
| 0x?A | a+   | ラ #                               |
| 0x?B | b    | シ                                 |
| 0x?C | z    | <TODO: 音階指定CMD> で指定した音階 |
| 0x?D | ^    | タイ                               |
| 0x?E | w    | 休符 (キーオフなし)                |
| 0x?F | r    | 休符 (キーオフあり)                |

#### tick数

tick数は、１つのシーケンスデータにつき10段階でデータを保持する。

使用頻度の少ないtick数に関しては、事前に <TODO: tick数設定CMD> で指定したtick数を `0xA?` で使用する。

| 値          | 概要                                   |
|-------------|----------------------------------------|
| 0x0? - 0x9? | 対応するtick数テーブルの値             |
| 0xA?        | <TODO: tick数設定CMD> で指定のtick数   |

**tpqn** (**t**icks **p**er **q**uarter **n**ote = 4分音符のtick数) は、デフォルト値は**48**とする。  
この数値はmml内で変動可能とする (最大値は **96** とする)。

### コマンド

1 bytes commands ( no arg )

#### [0xB0] EXIT: 曲の末端
#### [0xB1] RETURN: サブルーチンの末端
#### [0xB2] ECHO_ON: エコーON
#### [0xB3] ECHO_OFF: エコーOFF
#### [0xB4] PMOD_OFF: ピッチモジュレーションOFF
#### [0xB5] TREMOLO_OFF: トレモロOFF
#### [0xB6] PAN_LFO_OFF: パンLFOOFF
#### [0xB7] PENV_OFF: ピッチエンベロープOFF
#### [0xB8] DRUM_ON: ドラムモードON
#### [0xB9] DRUM_OFF: ドラムモードOFF
#### [0xBA] PORTM_ON: ポルタメントON
#### [0xBB] PORTM_OFF: ポルタメントOFF
#### [0xBC] OCTAVE_INC: オクターブ上げ
#### [0xBD] OCTAVE_DEC: オクターブ下げ
#### [0xBE] LOOP_END: ループ末端
#### [0xBF] 割り当て未定

----

2 bytes commands ( an arg )

#### [0xC0-00] HPM_ON: ハードピッチモジュレーションON
#### [0xC0-01] HPM_OFF: ハードピッチモジュレーションOFF
#### [0xC0-02] DISABLE_ECHO: エコー無効化

#### [0xC1] PRGCHG: 音色設定
#### [0xC2] SET_GVOL: 全体音量設定
#### [0xC3] SET_TRVOL: トラック音量設定
#### [0xC4] SET_EXP: エクスプレッション設定
#### [0xC5] SET_PAN: パンポット設定
#### [0xC6] SET_TEMPO: テンポ設定
#### [0xC7] SET_ABSTP: トランスポーズ
#### [0xC8] SET_RELTP: 相対トランスポーズ
#### [0xC9] SET_DETUNE: デチューン値設定
#### [0xCA] PIN_TR_CH: トラック固定
#### [0xCB] SET_OCTAVE: オクターブ設定
#### [0xCC] LOOP_BEGIN: ループ先頭
#### [0xCD] SET_LEN: tick数設定
#### [0xCE-0xCF] 割り当て未定

----

3 bytes commands ( 2 args )

#### [0xD0-00] SET_AR: AttackRate設定
#### [0xD0-01] SET_DR: DecayRate設定
#### [0xD0-02] SET_SR: SustainLevel設定
#### [0xD0-03] SET_SR: SustainRate設定
#### [0xD0-04] SET_RR: ReleaseRate設定
#### [0xD0-05] SET_GAIN1: Gain1設定
#### [0xD0-06] SET_GAIN2: Gain2設定
#### [0xD0-07] RESET_ADSR: ADSR設定復元
#### [0xD0-08] SET_SPWFRQ: 可変比矩形波周期設定
#### [0xD0-09] SET_SCALE: 音階指定

#### [0xD1] JUMP: 指定アドレスジャンプ ( ループ )
#### [0xD2] CALL: サブルーチンコール
#### [0xD3] FADE_GVOL: 全体音量フェード
#### [0xD4] FADE_EXP: エクスプレッションフェード
#### [0xD5] FADE_PAN: パンポットフェード
#### [0xD6] PAN_LFO_ON: パンLFOON
#### [0xD7] FADE_TEMPO: テンポフェード
#### [0xD8] SET_REL_PAT: リリースパターン設定
#### [0xD9-0xDF] : 割り当て未定

----

4 bytes commands ( 3 args )

#### [0xE0] PMOD_ON: ピッチモジュレーションON
#### [0xE1] TREMOLO_ON: トレモロON
#### [0xE2] PENV_ON: ピッチエンベロープON
#### [0xE3] PITCHBEND: ピッチベンド
#### [0xE4] SET_ECHOPARAM: エコーパラメータ設定
#### [0xE5-0xE7] : 割り当て未定

----

8 bytes commands ( 7 args )

#### [0xE8] SET_FIR: FIRフィルター設定


